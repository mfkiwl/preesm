#[[#]]# assumes in your $PATH: vitis_hls, vivado, unzip

all: ${KERNEL_NAME_TOP}.bit ${KERNEL_NAME_TOP}.hwh

${KERNEL_NAME_TOP}.bit: vivado/vivado.runs/impl_1/design_1_wrapper.bit
	cp $< $@

${KERNEL_NAME_TOP}.hwh: ${KERNEL_NAME_TOP}.bit
	unzip vivado/vivado.runs/impl_1/design_1_wrapper.hwdef design_1.hwh
	mv design_1.hwh $@

vivado/vivado.runs/impl_1/design_1_wrapper.bit: ${KERNEL_NAME_TOP}.zip ${KERNEL_NAME_READ}.zip ${KERNEL_NAME_WRITE}.zip
	mkdir ip ip/$KERNEL_NAME_TOP ip/$KERNEL_NAME_READ ip/$KERNEL_NAME_WRITE
	unzip ${KERNEL_NAME_TOP}.zip -d ip/$KERNEL_NAME_TOP
	unzip ${KERNEL_NAME_READ}.zip -d ip/$KERNEL_NAME_READ
	unzip ${KERNEL_NAME_WRITE}.zip -d ip/$KERNEL_NAME_WRITE
	vivado -mode tcl -source $SCRIPTS_SUBDIR/script_vivado.tcl

${KERNEL_NAME_TOP}.zip: $TOP_KERNEL_SOURCE
	vitis_hls $SCRIPTS_SUBDIR/script_hls.tcl $KERNEL_NAME_TOP $+

${KERNEL_NAME_READ}.zip: $READ_KERNEL_SOURCE
	vitis_hls $SCRIPTS_SUBDIR/script_hls.tcl $KERNEL_NAME_READ $+

${KERNEL_NAME_WRITE}.zip: $WRITE_KERNEL_SOURCE
	vitis_hls $SCRIPTS_SUBDIR/script_hls.tcl $KERNEL_NAME_WRITE $+



clean:
	rm -f ${KERNEL_NAME_TOP}.zip ${KERNEL_NAME_READ}.zip ${KERNEL_NAME_WRITE}.zip ${KERNEL_NAME_TOP}.bit ${KERNEL_NAME_TOP}.hwh

cleaner: clean
	rm -rf hls/ ip/ NA/ vivado/ *.log *.jou
